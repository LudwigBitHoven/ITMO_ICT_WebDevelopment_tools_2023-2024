<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ludwigbithoven.github.io/ITMO_ICT_WebDevelopment_tools_2023-2024/w/routes/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Routes - Лабораторная работа 1</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Routes";
        var mkdocs_page_input_path = "routes.md";
        var mkdocs_page_url = "/ITMO_ICT_WebDevelopment_tools_2023-2024/w/routes/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Лабораторная работа 1
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Лабораторная работа 1</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Бекенд на FastAPI</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="..">Описание варианта</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../main/">Main</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../models/">Models</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Routes</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#_2">Регистрация/Авторизация</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_3">Базовые ручки для юзера</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_4">Редактирование борда</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_5">Администрация борда</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_6">Редактирование тасков</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_7">Получение списка тасков</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../connection/">Connection</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Лабораторная работа 2</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">Потоки, процессы, асинхронность.</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="#">Сумматор</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../sum/">Импорты, базовый сумматор</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../sum_realisations/">Реализации сумматора</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../sum_launch/">Запуск</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Парсер/скрапер</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../description/">Импорты, базовый скрапер</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../backend/">Связь с БД</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../parsescrape/">Реализации скрапера</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../scrape_launch/">Запуск</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Лабораторная работа 1</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Лабораторная работа 1</li>
          <li class="breadcrumb-item">Бекенд на FastAPI</li>
      <li class="breadcrumb-item active">Routes</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">Эндпоинты<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>Ручки, запросы, skill-issue из-за каскадного удаления в sqlmodel/sqlalchemy.</p>
<h2 id="_2">Регистрация/Авторизация<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Для реализации хеширования и jwt токенов были использованы следующие библиотеки:</p>
<pre><code class="language-Python">from passlib.context import CryptContext
import jwt
</code></pre>
<p>Объявим основные функции для хеширования и проверки паролей, создания jwt токенов и их декодирования</p>
<pre><code class="language-Python">SECRET_KEY = &quot;iloveyou&quot;
ALGORITHM = &quot;HS256&quot;


router = APIRouter()
pwd_context = CryptContext(schemes=[&quot;bcrypt&quot;], deprecated=&quot;auto&quot;)


def hash_password(password: str):
    return pwd_context.hash(password)

def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

def create_access_token(data: dict):
    return jwt.encode(data, SECRET_KEY, algorithm=ALGORITHM)

def decode_token(token):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=ALGORITHM)
        return payload['sub']
    except Exception:
        return None
</code></pre>
<h2 id="_3">Базовые ручки для юзера<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<pre><code class="language-Python">@router.get(&quot;/me&quot;) # получение данных о себе
async def get_users(token, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        return {&quot;name&quot;: user.email}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.get(&quot;/users&quot;) # получение данных о всех юзерах в бд
async def get_users(token, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        result = session.scalars(select(User)).all()
        return result
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.patch(&quot;/change_password&quot;) # Смена пароля
async def change_password(token: str, old_password: str, new_password: str, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        if not verify_password(old_password, user.password):
            raise HTTPException(status_code=401, detail=&quot;Invalid old password&quot;)
        user.password = hash_password(new_password)
        session.add(user)
        session.commit()
        return {'message': 'success'}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.post(&quot;/signup&quot;) # регистрация
async def sign_up(user: User, session=Depends(get_session)):
    try:
        user.password = hash_password(user.password)
        session.add(user)
        session.commit()
        return {&quot;message&quot;: &quot;success&quot;}
    except exc.IntegrityError:
        return HTTPException(status_code=401, detail=&quot;User already exists&quot;)


@router.post(&quot;/login&quot;) # вход
async def login(user: User, session=Depends(get_session)):
    if not session.exec(select(User).where(User.email == user.email)).all():
        raise HTTPException(status_code=401, detail=&quot;Invalid email&quot;)
    hashed = session.execute(select(User.password).where(User.email == user.email)).first()
    if not verify_password(user.password, hashed.password):
        raise HTTPException(status_code=401, detail=&quot;Invalid password&quot;)
    access_token = create_access_token({&quot;sub&quot;: user.email, &quot;iat&quot;: datetime.datetime.utcnow(), &quot;exp&quot;: datetime.datetime.utcnow() + datetime.timedelta(hours=24)})
    return {&quot;access_token&quot;: access_token}
</code></pre>
<h2 id="_4">Редактирование борда<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<pre><code class="language-Python">@router.post(&quot;/create_board&quot;)
async def create_board(token: str, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        board = Board(users=[user], readonly=False)
        session.add(board)
        session.commit()
        user.boards.append(board)
        session.refresh(board)
        session.refresh(user)
        longboard = LongBoard(board_id=board.id)
        shortboard = ShortBoard(board_id=board.id)
        session.add(longboard)
        session.add(shortboard)
        session.commit()
        session.refresh(longboard)
        session.refresh(shortboard)
        return {&quot;message&quot;: board}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.delete(&quot;/delete_board&quot;) # не смог настроить каскадное удаление, поэтому делаю его вручную
async def delete_board(board_id: int, token: str, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(UsersBoardsLink).where(UsersBoardsLink.board_id == board_id, UsersBoardsLink.user_id == user.id)
        if session.scalars(cmd).all():
            # удаление борд
            delete_longboard = delete(LongBoard).where(LongBoard.board_id == board_id)
            delete_shortboard = delete(ShortBoard).where(ShortBoard.board_id == board_id)
            delete_board = delete(Board).where(Board.id == board_id)
            delete_link = delete(UsersBoardsLink).where(UsersBoardsLink.board_id == board_id)
            # удаление тасков
            cmd_longtasks = select(LongTasks.id).join(LongBoard).where(LongBoard.board_id == board_id)
            cmd_pertasks = select(PeriodicTasks.id).join(ShortBoard).where(ShortBoard.board_id == board_id)
            session.exec(delete(LongTasks).where(LongTasks.id.in_(cmd_longtasks)))
            session.exec(delete(PeriodicTasks).where(PeriodicTasks.id.in_(cmd_pertasks)))
            session.exec(delete_longboard)
            session.exec(delete_shortboard)
            session.exec(delete_link)
            session.exec(delete_board)
            session.commit()
            return {&quot;message&quot;: &quot;success&quot;}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)

</code></pre>
<h2 id="_5">Администрация борда<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<pre><code class="language-Python">@router.post(&quot;/invite_user&quot;)
async def invite_user(board_id: int, user_email: str, token: str, readonly: bool = True, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(UsersBoardsLink).where(UsersBoardsLink.board_id == board_id, UsersBoardsLink.user_id == user.id)
        if session.scalars(cmd).all():
            user_id = session.scalars(select(User.id).where(User.email == user_email)).one()
            link = UsersBoardsLink(user_id=user_id, board_id=board_id, readonly=readonly)
            session.add(link)
            session.commit()
            return {&quot;message&quot;: &quot;success&quot;}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.delete(&quot;/kick_user&quot;)
async def kick_user(board_id: int, user_email: str, token: str, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(UsersBoardsLink).where(UsersBoardsLink.board_id == board_id, UsersBoardsLink.user_id == user.id)
        if session.scalars(cmd).all():
            user_id = session.scalars(select(User.id).where(User.email == user_email)).one()
            unlink = delete(UsersBoardsLink).where(UsersBoardsLink.user_id == user_id, UsersBoardsLink.board_id == board_id)
            session.exec(unlink)
            session.commit()
            return {&quot;message&quot;: &quot;success&quot;}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)

</code></pre>
<h2 id="_6">Редактирование тасков<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<pre><code class="language-Python">@router.post(&quot;/create_long&quot;)
async def create_long(task: LongTasks, longboard_id: int, token: str, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(Board).join(LongBoard).join(UsersBoardsLink).where(LongBoard.id == longboard_id, UsersBoardsLink.user_id == user.id, LongBoard.board_id == Board.id, UsersBoardsLink.readonly == False)
        if session.scalars(cmd).all():
            task.longboard_id = longboard_id
            session.add(task)
            session.commit()
            session.refresh(task)
            return {&quot;message&quot;: &quot;success&quot;}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.post(&quot;/create_periodic&quot;)
async def create_periodic(task: PeriodicTasks, shortboard_id: int, token: str, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(Board).join(ShortBoard).join(UsersBoardsLink).where(ShortBoard.id == shortboard_id, UsersBoardsLink.user_id == user.id, ShortBoard.board_id == Board.id, UsersBoardsLink.readonly == False)
        if session.scalars(cmd).all():
            task.shortboard_id = shortboard_id
            session.add(task)
            session.commit()
            session.refresh(task)
            return {&quot;message&quot;: &quot;success&quot;}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.delete(&quot;/delete_periodic&quot;)
async def delete_periodic(task_id: int, shortboard_id: int, token: str, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(Board).join(ShortBoard).join(UsersBoardsLink).where(ShortBoard.id == shortboard_id, UsersBoardsLink.user_id == user.id, ShortBoard.board_id == Board.id, UsersBoardsLink.readonly == False)
        if session.scalars(cmd).all():
            delete_task = delete(PeriodicTasks).where(PeriodicTasks.shortboard_id == shortboard_id, PeriodicTasks.id == task_id)
            session.exec(delete_task)
            session.commit()
            return {&quot;message&quot;: &quot;success&quot;}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.delete(&quot;/delete_long&quot;)
async def delete_long(task_id: int, longboard_id: int, token: str, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(Board).join(LongBoard).join(UsersBoardsLink).where(LongBoard.id == longboard_id, UsersBoardsLink.user_id == user.id, LongBoard.board_id == Board.id, UsersBoardsLink.readonly == False)
        if session.scalars(cmd).all():
            delete_task = delete(LongTasks).where(LongTasks.longboard_id == longboard_id, LongTasks.id == task_id)
            session.exec(delete_task)
            session.commit()
            return {&quot;message&quot;: &quot;success&quot;}
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)

</code></pre>
<h2 id="_7">Получение списка тасков<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<pre><code class="language-Python">@router.get(&quot;/tasks&quot;)
async def get_tasks(token, board_id: int = None, session=Depends(get_session)):
    temp = decode_token(token)
    if temp: # проверка валиден ли токен
        user = session.scalars(select(User).where(User.email == temp)).one() # получаем юзера по почте, ассоциированной с токеном
        cmd = select(UsersBoardsLink).where(UsersBoardsLink.board_id == board_id, UsersBoardsLink.user_id == user.id) # проверяем есть ли доступ у пользователя к борду
        if session.scalars(cmd).all():
            cmd_long = select(LongTasks).join(LongBoard).join(Board).filter(LongBoard.board_id == board_id)
            cmd_per = select(PeriodicTasks).join(ShortBoard).join(Board).filter(ShortBoard.board_id == board_id)
            return session.scalars(cmd_per).all(), session.scalars(cmd_long).all()
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.get(&quot;/tasks/longtasks&quot;)
async def get_long(token, board_id: int = None, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(UsersBoardsLink).where(UsersBoardsLink.board_id == board_id, UsersBoardsLink.user_id == user.id)
        if session.scalars(cmd).all():
            cmd_long = select(LongTasks).join(LongBoard).join(Board).filter(LongBoard.board_id == board_id)
            return session.scalars(cmd_long).all()
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)


@router.get(&quot;/tasks/periodictasks&quot;)
async def get_periodic(token, board_id: int = None, session=Depends(get_session)):
    temp = decode_token(token)
    if temp:
        user = session.scalars(select(User).where(User.email == temp)).one()
        cmd = select(UsersBoardsLink).where(UsersBoardsLink.board_id == board_id, UsersBoardsLink.user_id == user.id)
        if session.scalars(cmd).all():
            cmd_per = select(PeriodicTasks).join(ShortBoard).join(Board).filter(ShortBoard.board_id == board_id)
            return session.scalars(cmd_per).all()
    raise HTTPException(status_code=403, detail=&quot;Forbidden&quot;)

</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../models/" class="btn btn-neutral float-left" title="Models"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../connection/" class="btn btn-neutral float-right" title="Connection">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../models/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../connection/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
